{% extends 'main.html' %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1><i class="fas fa-exclamation-triangle"></i> Unknown Devices</h1>
        <div class="page-actions">
            <button type="button" class="btn btn-success" onclick="processSelected('approve')">
                <i class="fas fa-check"></i> Move to Known
            </button>
            <button type="button" class="btn btn-warning" onclick="processSelected('update')">
                <i class="fas fa-edit"></i> Update Threat Level
            </button>
            <button type="button" class="btn btn-danger" onclick="processSelected('delete')">
                <i class="fas fa-trash"></i> Remove
            </button>
            <select id="threatLevel" class="form-select">
                <option value="low">Low Risk</option>
                <option value="medium" selected>Medium Risk</option>
                <option value="high">High Risk</option>
            </select>
            <input type="text" id="notes" class="form-control" placeholder="Update notes">
        </div>
    </div>

    <div class="device-grid">
        {% for device in devices %}
        <div class="device-card has-checkbox status-{{ device.threat_level }}">
            <input class="device-checkbox" type="checkbox" value="{{ device.mac }}" id="device-{{ loop.index }}">
            
            <h3>{{ device.hostname or 'Unknown Device' }}</h3>
            
            <div class="threat-badge threat-{{ device.threat_level }}">
                {{ device.threat_level.upper() }} THREAT
            </div>
            
            <p><strong>MAC:</strong> {{ device.mac }}</p>
            <p><strong>Last IP:</strong> {{ device.last_ip }}</p>
            <p><strong>First Seen:</strong> {{ device.first_seen }}</p>
            <p><strong>Last Seen:</strong> {{ device.last_seen }}</p>
            <p><strong>Detection Count:</strong> {{ device.detection_count }}</p>
            
            {% if device.notes %}
                <p><strong>Notes:</strong> {{ device.notes }}</p>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>

<script>
function processSelected(action) {
    const selected = Array.from(document.querySelectorAll('.device-checkbox:checked')).map(cb => cb.value);
    
    if (selected.length === 0) {
        showAlert('Please select at least one device', 'warning');
        return;
    }
    
    const data = {
        selected_devices: selected,
        action: action,
        threat_level: document.getElementById('threatLevel').value,
        notes: document.getElementById('notes').value
    };
    
    fetch('/unknown', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let message = data.message || 'Action completed successfully';
            showAlert(message, 'success');
            
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showAlert(data.error || 'Action failed', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Failed to process devices. Please check the logs.', 'error');
    });
}

function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.role = 'alert';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    document.querySelector('.container').insertBefore(
        alertDiv,
        document.querySelector('.container').firstChild
    );
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}
</script>
{% endblock %}
