{% extends 'base.html' %}

{% block title %}Netureon - Known Devices{% endblock %}

{% block header_title %}<i class="fas fa-shield-alt"></i> Network Device Dashboard{% endblock %}
{% block header_description %}Monitor and manage your network security in real-time{% endblock %}

{% block content %}

    <!-- Content Header -->
    <div class="content-header">
        <div>
            <h2><i class="fas fa-network-wired"></i> Known Devices</h2>
            <p class="text-muted mb-0">{{ devices|length }} devices monitored</p>
        </div>
        <div class="page-actions">
            <select class="form-select" id="sortSelect" onchange="sortDevices()">
                <option value="name">Sort by Name</option>
                <option value="status">Sort by Status</option>
                <option value="last_seen">Sort by Last Seen</option>
            </select>
            <select class="form-select" id="filterSelect" onchange="filterDevices()">
                <option value="all">All Devices</option>
                <option value="active">Active Only</option>
                <option value="inactive">Inactive Only</option>
            </select>
        </div>
    </div>

    <!-- Device Management Form -->
                <!-- Device Management Form -->
        <form method="POST" action="{{ url_for('main.main_page') }}">
            <!-- Device Grid -->
            <div class="device-grid">
                {% for device in devices %}
                <div class="device-card {% if device.is_active %}status-active{% else %}status-inactive{% endif %} has-checkbox">
                    <!-- Device Selection Checkbox -->
                    <input type="checkbox" name="selected_devices" value="{{ device.id }}" class="device-checkbox">
                    
                    <!-- Activity Indicator -->
                    <div class="activity-indicator {% if not device.is_active %}inactive{% endif %}"></div>
                    
                    <!-- Status Badge -->
                    <span class="status-badge {% if device.is_active %}status-active{% else %}status-inactive{% endif %}">
                        {% if device.is_active %}
                            <i class="fas fa-check-circle"></i> Active
                        {% else %}
                            <i class="fas fa-times-circle"></i> Inactive
                        {% endif %}
                    </span>

                    <!-- Device Header -->
                    <div class="device-header">
                        <h3>
                            <i class="fas fa-desktop"></i>
                            {{ device.hostname or device.ip_address or 'Unknown Device' }}
                        </h3>
                        {% if device.threat_level %}
                            <span class="threat-badge {{ device.threat_level }}">
                                {{ device.threat_level.upper() }} RISK
                            </span>
                        {% endif %}
                    </div>

                    <!-- Device Information -->
                    <div class="device-info">
                        <p><strong>IP Address:</strong> {{ device.ip_address or 'Unknown' }}</p>
                        <p><strong>MAC Address:</strong> {{ device.mac_address }}</p>
                        <p><strong>Vendor:</strong> {{ device.vendor or 'Unknown vendor' }}</p>
                        <p><strong>Device Type:</strong> {{ device.device_type or 'Unknown' }}</p>
                        <p><strong>Last Seen:</strong> {{ device.last_seen.strftime('%Y-%m-%d %H:%M:%S') if device.last_seen else 'Never' }}</p>
                        <p><strong>First Detected:</strong> {{ device.first_seen.strftime('%Y-%m-%d %H:%M:%S') if device.first_seen else 'Unknown' }}</p>
                        
                        {% if device.open_ports and device.open_ports|length > 0 %}
                            <p><strong>Open Ports:</strong></p>
                            <ul class="port-list">
                            {% for port in device.open_ports %}
                                <li><i class="fas fa-network-wired"></i> {{ port.port }} ({{ port.service or 'Unknown' }})</li>
                            {% endfor %}
                            </ul>
                        {% endif %}

                        {% if device.notes %}
                            <p><strong>Notes:</strong> {{ device.notes }}</p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button type="submit" name="action" value="mark_unknown" class="btn btn-warning">
                    <i class="fas fa-question-circle"></i> Mark as Unknown
                </button>
                <button type="submit" name="action" value="delete" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Remove Device
                </button>
                <button type="submit" name="action" value="block" class="btn btn-secondary">
                    <i class="fas fa-ban"></i> Block Device
                </button>
                <input type="text" name="notes" placeholder="Add notes for selected devices" class="form-control" style="flex: 1; min-width: 200px;">
                <button type="submit" name="action" value="add_notes" class="btn btn-primary">
                    <i class="fas fa-sticky-note"></i> Add Notes
                </button>
            </div>
        </form>

        {% if not devices %}
            <div class="text-center mt-8">
                <i class="fas fa-network-wired fa-3x text-muted mb-4"></i>
                <h3 class="text-muted">No known devices found</h3>
                <p class="text-muted">Devices will appear here once they are discovered and approved.</p>
                <a href="{{ url_for('unknown.unknown_devices') }}" class="btn btn-primary">
                    <i class="fas fa-search"></i> Check Unknown Devices
                </a>
            </div>
        {% endif %}
{% endblock %}

{% block extra_js %}
<script>
    function sortDevices() {
        const sortBy = document.getElementById('sortSelect').value;
        const deviceGrid = document.querySelector('.device-grid');
        const devices = Array.from(deviceGrid.children);
        
        devices.sort((a, b) => {
            let aValue, bValue;
            
            switch(sortBy) {
                case 'name':
                    aValue = a.querySelector('h3').textContent.trim().toLowerCase();
                    bValue = b.querySelector('h3').textContent.trim().toLowerCase();
                    break;
                case 'status':
                    aValue = a.classList.contains('status-active') ? 1 : 0;
                    bValue = b.classList.contains('status-active') ? 1 : 0;
                    return bValue - aValue; // Active first
                case 'last_seen':
                    // This would need the actual timestamp data for proper sorting
                    aValue = a.querySelector('.device-info p:last-of-type').textContent;
                    bValue = b.querySelector('.device-info p:last-of-type').textContent;
                    break;
                default:
                    return 0;
            }
            
            if (sortBy !== 'status') {
                return aValue < bValue ? -1 : aValue > bValue ? 1 : 0;
            }
        });
        
        devices.forEach(device => deviceGrid.appendChild(device));
    }
    
    function filterDevices() {
        const filterBy = document.getElementById('filterSelect').value;
        const devices = document.querySelectorAll('.device-card');
        
        devices.forEach(device => {
            let show = true;
            
            switch(filterBy) {
                case 'active':
                    show = device.classList.contains('status-active');
                    break;
                case 'inactive':
                    show = device.classList.contains('status-inactive');
                    break;
                case 'all':
                default:
                    show = true;
                    break;
            }
            
            device.style.display = show ? 'block' : 'none';
        });
    }
    
    // Checkbox selection functionality
    document.addEventListener('DOMContentLoaded', function() {
        const checkboxes = document.querySelectorAll('.device-checkbox');
        const actionButtons = document.querySelector('.action-buttons');
        
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const checkedBoxes = document.querySelectorAll('.device-checkbox:checked');
                actionButtons.style.display = checkedBoxes.length > 0 ? 'flex' : 'none';
            });
        });
        
        // Initially hide action buttons if no devices selected
        const checkedBoxes = document.querySelectorAll('.device-checkbox:checked');
        actionButtons.style.display = checkedBoxes.length > 0 ? 'flex' : 'none';
    });
</script>
{% endblock %}