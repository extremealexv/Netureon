{% extends "main.html" %}
{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-search"></i> Review New Devices</h1>
        <div class="actions">
            <button class="btn btn-success" onclick="approveSelected()">
                <i class="fas fa-check"></i> Approve Selected
            </button>
            <button class="btn btn-danger" onclick="blockSelected()">
                <i class="fas fa-ban"></i> Block Selected
            </button>
            <select class="form-select d-inline-block w-auto" id="riskLevel">
    <option value="low">Low Risk</option>
    <option value="medium" selected>Medium Risk</option>
    <option value="high">High Risk</option>
</select>
            <input type="text" class="form-control d-inline-block w-auto" placeholder="Add notes" id="notes">
        </div>
    </div>

    <div class="device-grid">
        {% for device in devices %}
        <div class="device-card">
            <div class="form-check float-end">
                <input class="form-check-input" type="checkbox" value="{{ device.mac_address }}" id="device-{{ loop.index }}">
            </div>
            <div class="device-info">
                <h3>{{ device.hostname or 'Unknown Device' }}</h3>
                <span class="badge {% if device.status %}bg-success{% else %}bg-warning{% endif %}">
                    {{ 'Reviewed' if device.status else 'Pending Review' }}
                </span>
                
                <p><strong>MAC:</strong> {{ device.mac_address }}</p>
                <p><strong>Vendor:</strong> {{ device.vendor or 'Unknown' }}</p>
                <p><strong>Type:</strong> {{ device.device_type or 'Unknown' }}</p>
                <p><strong>Last IP:</strong> {{ device.last_ip }}</p>
                <p><strong>First Seen:</strong> {{ device.first_seen }}</p>
                <p><strong>Last Seen:</strong> {{ device.last_seen }}</p>
                
                {% if device.open_ports %}
                    <p><strong>Open Ports:</strong></p>
                    {% if device.open_ports|length > 0 %}
                        <ul class="list-unstyled mb-0">
                        {% for port in device.open_ports %}
                            <li>{{ port.port }} ({{ port.service }})</li>
                        {% endfor %}
                        </ul>
                    {% else %}
                        <span class="text-muted">No open ports detected</span>
                    {% endif %}
                {% endif %}

                {% if device.notes %}
                    <p><strong>Notes:</strong> {{ device.notes }}</p>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
function approveSelected() {
    const selected = getSelectedDevices();
    if (selected.length === 0) {
        alert('Please select devices to approve');
        return;
    }
    
    const data = {
        devices: selected,
        risk_level: document.getElementById('riskLevel').value,
        notes: document.getElementById('notes').value
    };
    
    fetch('/review/approve', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            const message = data.message + 
                (data.notification_error ? '\n\nNotification error: ' + data.notification_error : '');
            
            showAlert(message, data.notification_error ? 'warning' : 'success');
            
            // Reload after a short delay to show the message
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showAlert(data.error || 'Failed to approve devices', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Failed to approve devices. Please check the logs.', 'error');
    });
}

function blockSelected() {
    const selected = getSelectedDevices();
    if (selected.length === 0) {
        showAlert('Please select devices to block', 'warning');
        return;
    }
    
    const data = {
        devices: selected,
        notes: document.getElementById('notes').value
    };
    
    fetch('/review/block', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            const message = data.message + 
                (data.notification_error ? '\n\nNotification error: ' + data.notification_error : '');
            
            showAlert(message, data.notification_error ? 'warning' : 'success');
            
            // Reload after a short delay to show the message
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showAlert(data.error || 'Failed to block devices', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Failed to block devices. Please check the logs.', 'error');
    });
}

function getSelectedDevices() {
    return Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
        .map(cb => cb.value);
}

function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.role = 'alert';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    // Insert at the top of the content
    document.querySelector('.container').insertBefore(
        alertDiv,
        document.querySelector('.container').firstChild
    );
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}
</script>
{% endblock %}
