#!/bin/bash

# Health check script for Netureon services
# This script checks the status of all Netureon components

check_service() {
    local service=$1
    echo -n "Checking $service... "
    if systemctl is-active --quiet "$service"; then
        echo "âœ… Running"
        return 0
    else
        echo "âŒ Not running"
        return 1
    fi
}

check_web_interface() {
    local host=${FLASK_HOST:-0.0.0.0}
    local port=${FLASK_PORT:-5000}
    echo -n "Checking web interface... "
    if curl -s "http://$host:$port/system" > /dev/null; then
        echo "âœ… Accessible"
        return 0
    else
        echo "âŒ Not accessible"
        return 1
    fi
}

check_database() {
    echo -n "Checking database connection... "
    if PGPASSWORD=$DB_PASSWORD psql -h "$DB_HOST" -U "$DB_USER" -d "$DB_NAME" -c '\q' 2>/dev/null; then
        echo "âœ… Connected"
        return 0
    else
        echo "âŒ Connection failed"
        return 1
    fi
}

# Source environment variables
source .env

# Print header
echo "ğŸ›¡ï¸ Netureon Health Check"
echo "======================="
echo

# Check services
echo "Checking system services..."
status=0
check_service "netureon" || status=1
check_service "netureon-alerts" || status=1
check_service "netureon_web" || status=1
check_service "netureon_scan.timer" || status=1

# Check web interface
echo -e "\nChecking web interface..."
check_web_interface || status=1

# Check database
echo -e "\nChecking database..."
check_database || status=1

# Check disk space
echo -e "\nChecking disk space..."
free_space=$(df -h . | awk 'NR==2 {print $4}')
free_space_num=$(df . | awk 'NR==2 {print $4}')
if [ "$free_space_num" -lt 5242880 ]; then  # Less than 5GB
    echo "âŒ Low disk space: $free_space available"
    status=1
else
    echo "âœ… Disk space: $free_space available"
fi

# Check Python environment
echo -e "\nChecking Python environment..."
if [ -d "venv" ]; then
    echo "âœ… Virtual environment exists"
    if source venv/bin/activate 2>/dev/null; then
        python_version=$(python -V 2>&1)
        echo "âœ… Python version: $python_version"
    else
        echo "âŒ Failed to activate virtual environment"
        status=1
    fi
else
    echo "âŒ Virtual environment not found"
    status=1
fi

# Final status
echo -e "\n======================="
if [ $status -eq 0 ]; then
    echo "âœ… All checks passed"
else
    echo "âŒ Some checks failed"
fi

exit $status
